name: Cluster

on:
  workflow_dispatch:
    inputs:
      period:
        description: 'Date to cluster (YYYY-MM-DD, defaults to today)'
        required: false
        type: string
      window:
        description: 'Number of days to include'
        required: false
        default: '1'
        type: string
      location_min_confidence:
        description: 'Minimum confidence for location inclusion (default: 0.65)'
        required: false
        type: string
      location_max_locations:
        description: 'Maximum countries per story (default: 10)'
        required: false
        type: string
      location_max_regions:
        description: 'Maximum regions per country (default: 5)'
        required: false
        type: string
      location_max_cities:
        description: 'Maximum cities per country (default: 5)'
        required: false
        type: string

env:
  S3_BUCKET: ${{ secrets.S3_BUCKET }}

jobs:
  cluster:
    runs-on: ubuntu-latest

    steps:
      - name: Validate S3_BUCKET secret
        run: |
          if [ -z "$S3_BUCKET" ]; then
            echo "::error::Missing required secret: S3_BUCKET"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cache-venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-cluster-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root --without ingest --without normalize

      - name: Run clustering
        run: |
          ARGS="--config prod"
          if [ -n "${{ inputs.period }}" ]; then
            ARGS="$ARGS --period ${{ inputs.period }}"
          fi
          if [ -n "${{ inputs.window }}" ]; then
            ARGS="$ARGS --window ${{ inputs.window }}"
          fi
          if [ -n "${{ inputs.location_min_confidence }}" ]; then
            ARGS="$ARGS --location-min-confidence ${{ inputs.location_min_confidence }}"
          fi
          if [ -n "${{ inputs.location_max_locations }}" ]; then
            ARGS="$ARGS --location-max-locations ${{ inputs.location_max_locations }}"
          fi
          if [ -n "${{ inputs.location_max_regions }}" ]; then
            ARGS="$ARGS --location-max-regions ${{ inputs.location_max_regions }}"
          fi
          if [ -n "${{ inputs.location_max_cities }}" ]; then
            ARGS="$ARGS --location-max-cities ${{ inputs.location_max_cities }}"
          fi
          poetry run python services/news-cluster/cluster.py $ARGS

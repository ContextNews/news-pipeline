name: Reset

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'What to reset'
        required: true
        type: choice
        options:
          - all
          - ingested
          - cleaned
          - embedded
        default: 'all'
      confirm:
        description: 'Type "RESET" to confirm deletion'
        required: true
        type: string

jobs:
  reset:
    runs-on: ubuntu-latest
    if: ${{ inputs.confirm == 'RESET' }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-west-2

      - name: Install boto3
        run: pip install boto3

      - name: Clear ingested data (S3)
        if: ${{ inputs.target == 'all' || inputs.target == 'ingested' }}
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          python -c "
          import os
          import boto3

          client = boto3.client('s3')
          bucket = os.environ['S3_BUCKET_NAME']
          prefix = 'ingested_articles/'

          paginator = client.get_paginator('list_objects_v2')
          deleted = 0

          for page in paginator.paginate(Bucket=bucket, Prefix=prefix):
              if 'Contents' not in page:
                  continue
              objects = [{'Key': obj['Key']} for obj in page['Contents']]
              if objects:
                  client.delete_objects(Bucket=bucket, Delete={'Objects': objects})
                  deleted += len(objects)

          print(f'Deleted {deleted} objects from s3://{bucket}/{prefix}')
          "

      - name: Clear cleaned data (S3)
        if: ${{ inputs.target == 'all' || inputs.target == 'cleaned' }}
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          python -c "
          import os
          import boto3

          client = boto3.client('s3')
          bucket = os.environ['S3_BUCKET_NAME']
          prefix = 'cleaned_articles/'

          paginator = client.get_paginator('list_objects_v2')
          deleted = 0

          for page in paginator.paginate(Bucket=bucket, Prefix=prefix):
              if 'Contents' not in page:
                  continue
              objects = [{'Key': obj['Key']} for obj in page['Contents']]
              if objects:
                  client.delete_objects(Bucket=bucket, Delete={'Objects': objects})
                  deleted += len(objects)

          print(f'Deleted {deleted} objects from s3://{bucket}/{prefix}')
          "

      - name: Clear embedded data (S3)
        if: ${{ inputs.target == 'all' || inputs.target == 'embedded' }}
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          python -c "
          import os
          import boto3

          client = boto3.client('s3')
          bucket = os.environ['S3_BUCKET_NAME']
          prefix = 'embedded_articles/'

          paginator = client.get_paginator('list_objects_v2')
          deleted = 0

          for page in paginator.paginate(Bucket=bucket, Prefix=prefix):
              if 'Contents' not in page:
                  continue
              objects = [{'Key': obj['Key']} for obj in page['Contents']]
              if objects:
                  client.delete_objects(Bucket=bucket, Delete={'Objects': objects})
                  deleted += len(objects)

          print(f'Deleted {deleted} objects from s3://{bucket}/{prefix}')
          "

      - name: Summary
        run: echo "Reset complete for target '${{ inputs.target }}'"

  rejected:
    runs-on: ubuntu-latest
    if: ${{ inputs.confirm != 'RESET' }}

    steps:
      - name: Confirmation failed
        run: |
          echo "::error::You must type RESET to confirm. Got: '${{ inputs.confirm }}'"
          exit 1

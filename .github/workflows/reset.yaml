name: Reset

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'What to reset'
        required: true
        type: choice
        options:
          - all
          - raw
          - normalized
        default: 'all'
      confirm:
        description: 'Type "RESET" to confirm deletion'
        required: true
        type: string

jobs:
  reset:
    runs-on: ubuntu-latest
    if: ${{ inputs.confirm == 'RESET' }}

    steps:
      - name: Install dependencies
        run: pip install psycopg2-binary boto3

      - name: Clear ingest state (Postgres)
        if: ${{ inputs.target == 'all' || inputs.target == 'raw' }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python -c "
          import os
          import psycopg2
          conn = psycopg2.connect(os.environ['DATABASE_URL'])
          cur = conn.cursor()
          cur.execute('DELETE FROM source_state')
          conn.commit()
          print(f'Deleted {cur.rowcount} rows from source_state')
          conn.close()
          "

      - name: Clear raw data (S3)
        if: ${{ inputs.target == 'all' || inputs.target == 'raw' }}
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          python -c "
          import os
          import boto3

          client = boto3.client(
              's3',
              endpoint_url=os.environ.get('S3_ENDPOINT'),
              aws_access_key_id=os.environ['AWS_ACCESS_KEY_ID'],
              aws_secret_access_key=os.environ['AWS_SECRET_ACCESS_KEY'],
          )

          bucket = os.environ['S3_BUCKET']
          prefix = 'news-raw/'

          paginator = client.get_paginator('list_objects_v2')
          deleted = 0

          for page in paginator.paginate(Bucket=bucket, Prefix=prefix):
              if 'Contents' not in page:
                  continue
              objects = [{'Key': obj['Key']} for obj in page['Contents']]
              if objects:
                  client.delete_objects(Bucket=bucket, Delete={'Objects': objects})
                  deleted += len(objects)

          print(f'Deleted {deleted} objects from s3://{bucket}/{prefix}')
          "

      - name: Clear normalized data (S3)
        if: ${{ inputs.target == 'all' || inputs.target == 'normalized' }}
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_ENDPOINT: ${{ secrets.S3_ENDPOINT }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          python -c "
          import os
          import boto3

          client = boto3.client(
              's3',
              endpoint_url=os.environ.get('S3_ENDPOINT'),
              aws_access_key_id=os.environ['AWS_ACCESS_KEY_ID'],
              aws_secret_access_key=os.environ['AWS_SECRET_ACCESS_KEY'],
          )

          bucket = os.environ['S3_BUCKET']
          prefix = 'news-normalized/'

          paginator = client.get_paginator('list_objects_v2')
          deleted = 0

          for page in paginator.paginate(Bucket=bucket, Prefix=prefix):
              if 'Contents' not in page:
                  continue
              objects = [{'Key': obj['Key']} for obj in page['Contents']]
              if objects:
                  client.delete_objects(Bucket=bucket, Delete={'Objects': objects})
                  deleted += len(objects)

          print(f'Deleted {deleted} objects from s3://{bucket}/{prefix}')
          "

      - name: Summary
        run: echo "Reset complete for target '${{ inputs.target }}'"

  rejected:
    runs-on: ubuntu-latest
    if: ${{ inputs.confirm != 'RESET' }}

    steps:
      - name: Confirmation failed
        run: |
          echo "::error::You must type RESET to confirm. Got: '${{ inputs.confirm }}'"
          exit 1

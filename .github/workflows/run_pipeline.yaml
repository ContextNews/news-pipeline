name: Run Pipeline

on:
  schedule:
    - cron: "0 6,18 * * *"
  workflow_dispatch:
    inputs:
      ingest-lookback-hours:
        description: 'Number of hours to look back for articles'
        type: number
        default: 12
      ingest-sources:
        description: 'Sources'
        type: string
        default: 'all'
      ingest-load-s3:
        description: 'Load ingested articles to S3'
        type: boolean
        default: true
      ingest-load-rds:
        description: 'Load ingested articles to RDS'
        type: boolean
        default: true
      embed-ingested-date:
        description: 'UTC date to load from RDS (YYYY-MM-DD)'
        type: string
        default: ''
      embed-model:
        description: 'Sentence-transformers model name'
        type: string
        default: 'all-MiniLM-L6-v2'
      embed-batch-size:
        description: 'Batch size for encoding'
        type: number
        default: 32
      embed-word-limit:
        description: 'Embedded words limit'
        type: number
        default: 300
      embed-no-title:
        description: 'Exclude title from embedding'
        type: boolean
        default: false
      embed-no-summary:
        description: 'Exclude summary from embedding'
        type: boolean
        default: false
      embed-no-text:
        description: 'Exclude text from embedding'
        type: boolean
        default: false
      embed-overwrite:
        description: 'Re-embed articles even if already embedded for this model'
        type: boolean
        default: false
      embed-load-s3:
        description: 'Load articles to S3'
        type: boolean
        default: true
      embed-load-rds:
        description: 'Load articles to RDS'
        type: boolean
        default: true
      cluster-ingested-date:
        description: 'UTC date to load from RDS (YYYY-MM-DD)'
        type: string
        default: ''
      cluster-embedding-model:
        description: 'Embedding model to use'
        type: string
        default: 'all-MiniLM-L6-v2'
      cluster-min-cluster-size:
        description: 'Minimum cluster size'
        type: number
        default: 2
      cluster-min-samples:
        description: 'Minimum samples (leave empty for default)'
        type: number
        default: 0
      cluster-load-s3:
        description: 'Load to S3'
        type: boolean
        default: true
      cluster-load-rds:
        description: 'Load to RDS'
        type: boolean
        default: true
      cluster-overwrite-clusters:
        description: 'Overwrite existing clusters'
        type: boolean
        default: true

permissions:
  id-token: write
  contents: read

jobs:
  ingest:
    uses: ./.github/workflows/ingest_articles.yaml
    secrets: inherit
    with:
      lookback-hours: ${{ fromJSON(inputs.ingest-lookback-hours || '12') }}
      sources: ${{ inputs.ingest-sources || 'all' }}
      load-s3: ${{ inputs.ingest-load-s3 != false }}
      load-rds: ${{ inputs.ingest-load-rds != false }}

  embed:
    needs: ingest
    uses: ./.github/workflows/compute_embeddings.yaml
    secrets: inherit
    with:
      ingested-date: ${{ inputs.embed-ingested-date || '' }}
      model: ${{ inputs.embed-model || 'all-MiniLM-L6-v2' }}
      batch-size: ${{ fromJSON(inputs.embed-batch-size || '32') }}
      word-limit: ${{ fromJSON(inputs.embed-word-limit || '300') }}
      no-title: ${{ inputs.embed-no-title == true }}
      no-summary: ${{ inputs.embed-no-summary == true }}
      no-text: ${{ inputs.embed-no-text == true }}
      overwrite: ${{ inputs.embed-overwrite == true }}
      load-s3: ${{ inputs.embed-load-s3 != false }}
      load-rds: ${{ inputs.embed-load-rds != false }}

  cluster:
    needs: embed
    uses: ./.github/workflows/cluster_articles.yaml
    secrets: inherit
    with:
      ingested-date: ${{ inputs.cluster-ingested-date || '' }}
      embedding-model: ${{ inputs.cluster-embedding-model || 'all-MiniLM-L6-v2' }}
      min-cluster-size: ${{ fromJSON(inputs.cluster-min-cluster-size || '2') }}
      min-samples: ${{ fromJSON(inputs.cluster-min-samples || '0') }}
      load-s3: ${{ inputs.cluster-load-s3 != false }}
      load-rds: ${{ inputs.cluster-load-rds != false }}
      overwrite-clusters: ${{ inputs.cluster-overwrite-clusters != false }}
